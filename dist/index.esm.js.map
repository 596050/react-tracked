{"version":3,"file":"index.esm.js","sources":["../src/utils.ts","../src/useUpdate.ts","../src/useTrackedState.ts","../src/useSelector.ts","../src/createContainer.ts","../src/memo.ts"],"sourcesContent":["import {\n  useEffect,\n  useRef,\n  useDebugValue,\n} from 'react';\n\ntype Obj = Record<string, unknown>;\n\nconst affectedToPathList = <State>(\n  state: State,\n  affected: WeakMap<Obj, Set<string>>,\n) => {\n  const list: string[][] = [];\n  const walk = (obj: unknown, path?: string[]) => {\n    const used = affected.get(obj as Obj);\n    if (used) {\n      used.forEach((key) => {\n        walk((obj as { [k: string]: Obj })[key], path ? [...path, key] : [key]);\n      });\n    } else if (path) {\n      list.push(path);\n    }\n  };\n  walk(state);\n  return list;\n};\n\nexport const useAffectedDebugValue = <State>(\n  state: State,\n  affected: WeakMap<Obj, Set<string>>,\n) => {\n  const pathList = useRef<string[][]>();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(pathList.current);\n};\n","import {\n  Context as ContextOrig,\n  useContext as useContextOrig,\n} from 'react';\n\nexport const useUpdate = <Update>(\n  UpdateContext: ContextOrig<Update>,\n) => {\n  const update = useContextOrig(UpdateContext);\n  return update;\n};\n","import {\n  Context as ContextOrig,\n  useMemo,\n  useRef,\n  useEffect,\n} from 'react';\nimport {\n  Context,\n  useContext,\n} from 'use-context-selector';\nimport {\n  createDeepProxy,\n  isDeepChanged,\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED,\n  MODE_IGNORE_REF_EQUALITY,\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP,\n} from 'proxy-compare';\n\nimport { useAffectedDebugValue } from './utils';\nimport { useUpdate } from './useUpdate';\n\nconst MODE_ALWAYS_ASSUME_CHANGED_IF_UNAFFECTED = 0;\nconst MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED = (\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED | MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP\n);\nconst MODE_MUTABLE_ROOT_STATE = MODE_IGNORE_REF_EQUALITY; // only for root\nconst MODE_DEFAULT = MODE_ASSUME_UNCHANGED_IF_UNAFFECTED; // only for root\n\ntype Opts = {\n  /* eslint-disable camelcase */\n  unstable_forceUpdateForStateChange?: boolean;\n  unstable_ignoreIntermediateObjectUsage?: boolean;\n  unstable_ignoreStateEquality?: boolean;\n  /* eslint-enable camelcase */\n};\n\nexport const useTrackedState = <State>(\n  StateContext: Context<State>,\n  opts: Opts = {},\n) => {\n  const affected = new WeakMap();\n  const lastAffected = useRef<WeakMap<Record<string, unknown>, unknown>>();\n  useEffect(() => {\n    lastAffected.current = affected;\n  });\n  const deepChangedMode = (\n    /* eslint-disable no-nested-ternary, indent, no-multi-spaces */\n      opts.unstable_forceUpdateForStateChange     ? MODE_ALWAYS_ASSUME_CHANGED_IF_UNAFFECTED\n    : opts.unstable_ignoreIntermediateObjectUsage ? MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED\n    : opts.unstable_ignoreStateEquality           ? MODE_MUTABLE_ROOT_STATE\n    : /* default */                                 MODE_DEFAULT\n    /* eslint-enable no-nested-ternary, indent, no-multi-spaces */\n  );\n  const selector = useMemo(() => {\n    let prevState: State | null = null;\n    const deepChangedCache = new WeakMap();\n    return (nextState: State) => {\n      if (prevState !== null\n        && prevState !== nextState\n        && lastAffected.current\n        && !isDeepChanged(\n          prevState,\n          nextState,\n          lastAffected.current,\n          deepChangedCache,\n          deepChangedMode,\n        )\n      ) {\n        // not changed\n        return prevState;\n      }\n      prevState = nextState;\n      return nextState;\n    };\n  }, [deepChangedMode]);\n  const state = useContext(StateContext, selector);\n  if (process.env.NODE_ENV !== 'production') {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    useAffectedDebugValue(state, affected);\n  }\n  const proxyCache = useMemo(() => new WeakMap(), []); // per-hook proxyCache\n  return createDeepProxy(state, affected, proxyCache);\n};\n\nexport const useTracked = <State, Update>(\n  StateContext: Context<State>,\n  UpdateContext: ContextOrig<Update>,\n  opts?: Opts,\n) => {\n  const state = useTrackedState(StateContext, opts);\n  const update = useUpdate(UpdateContext);\n  return useMemo(() => [state, update], [state, update]) as [State, Update];\n};\n","import {\n  useDebugValue,\n} from 'react';\nimport {\n  Context,\n  useContext,\n} from 'use-context-selector';\n\nexport const useSelector = <State, Selected>(\n  StateContext: Context<State>,\n  selector: (state: State) => Selected,\n) => {\n  const selected = useContext(StateContext, selector);\n  useDebugValue(selected);\n  return selected;\n};\n","import {\n  FC,\n  createContext as createContextOrig,\n  createElement,\n  useMemo,\n} from 'react';\nimport {\n  createContext,\n  wrapCallbackWithPriority,\n} from 'use-context-selector';\n\nimport {\n  useTrackedState as useTrackedStateOrig,\n  useTracked as useTrackedOrig,\n} from './useTrackedState';\nimport { useUpdate as useUpdateOrig } from './useUpdate';\nimport { useSelector as useSelectorOrig } from './useSelector';\n\nconst warningObject = new Proxy({}, {\n  get() { throw new Error('Please use <Provider>'); },\n  apply() { throw new Error('Please use <Provider>'); },\n});\n\nexport const createContainer = <State, Update extends (...args: any) => any, Props>(\n  useValue: (props: Props) => readonly [State, Update],\n) => {\n  const StateContext = createContext(warningObject as State);\n  const UpdateContext = createContextOrig(warningObject as Update);\n  const Provider: FC<Props> = (props) => {\n    const [state, update] = useValue(props);\n    const updateValue = useMemo(() => wrapCallbackWithPriority(update), [update]);\n    return createElement(UpdateContext.Provider, { value: updateValue },\n      createElement(StateContext.Provider, { value: state }, props.children));\n  };\n  const useTrackedState = (\n    opts?: Parameters<typeof useTrackedStateOrig>[1],\n  ) => useTrackedStateOrig(StateContext, opts);\n  const useTracked = (\n    opts?: Parameters<typeof useTrackedOrig>[2],\n  ) => useTrackedOrig(StateContext, UpdateContext, opts);\n  const useUpdate = () => useUpdateOrig(UpdateContext);\n  const useSelector = <Selected>(\n    selector: (state: State) => Selected,\n  ) => useSelectorOrig(StateContext, selector);\n  return {\n    Provider,\n    useTrackedState,\n    useTracked,\n    useUpdate,\n    useSelector,\n  } as const;\n};\n","import { ComponentProps, createElement, memo as reactMemo } from 'react';\n\nimport { trackMemo } from 'proxy-compare';\n\nexport const memo = (\n  Component: Parameters<typeof reactMemo>[0],\n  areEqual?: Parameters<typeof reactMemo>[1],\n) => {\n  const WrappedComponent = (props: ComponentProps<typeof Component>) => {\n    Object.values(props).forEach(trackMemo);\n    return createElement(Component, props);\n  };\n  return reactMemo(WrappedComponent, areEqual);\n};\n"],"names":["useUpdate","UpdateContext","useContextOrig","MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED","MODE_ASSUME_UNCHANGED_IF_UNAFFECTED","MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP","MODE_MUTABLE_ROOT_STATE","MODE_IGNORE_REF_EQUALITY","MODE_DEFAULT","useTrackedState","StateContext","opts","affected","WeakMap","lastAffected","useRef","useEffect","current","deepChangedMode","unstable_forceUpdateForStateChange","unstable_ignoreIntermediateObjectUsage","unstable_ignoreStateEquality","selector","useMemo","prevState","deepChangedCache","nextState","isDeepChanged","state","useContext","process","env","NODE_ENV","pathList","list","walk","obj","path","used","get","forEach","key","push","affectedToPathList","useDebugValue","useAffectedDebugValue","proxyCache","createDeepProxy","useTracked","update","useSelector","selected","warningObject","Proxy","Error","apply","createContainer","useValue","createContext","createContextOrig","Provider","props","updateValue","wrapCallbackWithPriority","createElement","value","children","useTrackedStateOrig","useTrackedOrig","useUpdateOrig","useSelectorOrig","memo","Component","areEqual","reactMemo","Object","values","trackMemo"],"mappings":"yhBAQA,ICHaA,EAAY,SACvBC,GAGA,OADeC,EAAeD,ICc1BE,EACJC,EAAsCC,EAElCC,EAA0BC,EAC1BC,EAAeJ,EAURK,EAAkB,SAC7BC,EACAC,YAAAA,IAAAA,EAAa,IAEb,IAAMC,EAAW,IAAIC,QACfC,EAAeC,IACrBC,EAAU,WACRF,EAAaG,QAAUL,IAEzB,IAAMM,EAEFP,EAAKQ,mCA1BsC,EA2B3CR,EAAKS,uCAAyCjB,EAC9CQ,EAAKU,6BAAyCf,EACAE,EAG5Cc,EAAWC,EAAQ,WACvB,IAAIC,EAA0B,KACxBC,EAAmB,IAAIZ,QAC7B,gBAAQa,GACN,OAAkB,OAAdF,GACCA,IAAcE,GACdZ,EAAaG,UACZU,EACFH,EACAE,EACAZ,EAAaG,QACbQ,EACAP,GAIKM,GAETA,EAAYE,EACLA,KAER,CAACR,IACEU,EAAQC,EAAWnB,EAAcY,GACV,eAAzBQ,QAAQC,IAAIC,UFjDmB,SACnCJ,EACAhB,GAEA,IAAMqB,EAAWlB,IACjBC,EAAU,WACRiB,EAAShB,QAzBc,SACzBW,EACAhB,GAEA,IAAMsB,EAAmB,GAYzB,OAXa,SAAPC,EAAQC,EAAcC,GAC1B,IAAMC,EAAO1B,EAAS2B,IAAIH,GACtBE,EACFA,EAAKE,QAAQ,SAACC,GACZN,EAAMC,EAA6BK,GAAMJ,YAAWA,GAAMI,IAAO,CAACA,MAE3DJ,GACTH,EAAKQ,KAAKL,GAGdF,CAAKP,GACEM,EAScS,CAAmBf,EAAOhB,KAE/CgC,EAAcX,EAAShB,SE2CrB4B,CAAsBjB,EAAOhB,GAE/B,IAAMkC,EAAavB,EAAQ,sBAAUV,SAAW,IAChD,OAAOkC,EAAgBnB,EAAOhB,EAAUkC,IAG7BE,EAAa,SACxBtC,EACAT,EACAU,GAEA,IAAMiB,EAAQnB,EAAgBC,EAAcC,GACtCsC,EAASjD,EAAUC,GACzB,OAAOsB,EAAQ,iBAAM,CAACK,EAAOqB,IAAS,CAACrB,EAAOqB,KCnFnCC,EAAc,SACzBxC,EACAY,GAEA,IAAM6B,EAAWtB,EAAWnB,EAAcY,GAE1C,OADAsB,EAAcO,GACPA,GCIHC,EAAgB,IAAIC,MAAM,GAAI,CAClCd,eAAQ,UAAUe,MAAM,0BACxBC,iBAAU,UAAUD,MAAM,4BAGfE,EAAkB,SAC7BC,GAEA,IAAM/C,EAAegD,EAAcN,GAC7BnD,EAAgB0D,EAAkBP,GAiBxC,MAAO,CACLQ,SAjB0B,SAACC,SACHJ,EAASI,GAA1BjC,OAAOqB,OACRa,EAAcvC,EAAQ,kBAAMwC,EAAyBd,IAAS,CAACA,IACrE,OAAOe,EAAc/D,EAAc2D,SAAU,CAAEK,MAAOH,GACpDE,EAActD,EAAakD,SAAU,CAAEK,MAAOrC,GAASiC,EAAMK,YAc/DzD,gBAZsB,SACtBE,UACGwD,EAAoBzD,EAAcC,IAWrCqC,WAViB,SACjBrC,UACGyD,EAAe1D,EAAcT,EAAeU,IAS/CX,UARgB,kBAAMqE,EAAcpE,IASpCiD,YARkB,SAClB5B,UACGgD,EAAgB5D,EAAcY,MCvCxBiD,EAAO,SAClBC,EACAC,GAMA,OAAOC,EAJkB,SAACb,GAExB,OADAc,OAAOC,OAAOf,GAAOrB,QAAQqC,GACtBb,EAAcQ,EAAWX,IAECY"}