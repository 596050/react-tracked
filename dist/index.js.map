{"version":3,"file":"index.js","sources":["../src/utils.ts","../src/createProvider.ts","../src/useUpdate.ts","../src/useTrackedState.ts","../src/useSelector.ts","../src/createContainer.ts"],"sourcesContent":["import {\n  useEffect,\n  useLayoutEffect,\n  useRef,\n  useDebugValue,\n} from 'react';\n\nconst isClient = (\n  typeof window !== 'undefined'\n  && !/ServerSideRendering/.test(window.navigator && window.navigator.userAgent)\n);\n\nexport const useIsomorphicLayoutEffect = isClient ? useLayoutEffect : useEffect;\n\nconst affectedToPathList = <State>(\n  state: State,\n  affected: WeakMap<object, Set<string>>,\n) => {\n  const list: string[][] = [];\n  const walk = (obj: unknown, path?: string[]) => {\n    const used = affected.get(obj as object);\n    if (used) {\n      used.forEach((key) => {\n        walk((obj as { [k: string]: object })[key], path ? [...path, key] : [key]);\n      });\n    } else if (path) {\n      list.push(path);\n    }\n  };\n  walk(state);\n  return list;\n};\n\nexport const useAffectedDebugValue = <State>(\n  state: State,\n  affected: WeakMap<object, Set<string>>,\n) => {\n  const pathList = useRef<string[][]>();\n  useEffect(() => {\n    pathList.current = affectedToPathList(state, affected);\n  });\n  useDebugValue(pathList);\n};\n","/* eslint-disable @typescript-eslint/ban-ts-ignore */\n\nimport {\n  Context,\n  FC,\n  MutableRefObject,\n  // @ts-ignore\n  createMutableSource,\n  createElement,\n  useCallback,\n  useMemo,\n  useRef,\n} from 'react';\nimport {\n  unstable_UserBlockingPriority as UserBlockingPriority,\n  unstable_NormalPriority as NormalPriority,\n  unstable_runWithPriority as runWithPriority,\n} from 'scheduler';\n\nimport { useIsomorphicLayoutEffect } from './utils';\n\nexport const MUTABLE_SOURCE_CONTEXT_PROPERTY = 's';\nexport const UPDATE_CONTEXT_PROPERTY = 'u';\n\nexport const STATEREF_SOURCE_PROPERTY = 'r';\nexport const LISTENERS_SOURCE_PROPERTY = 'l';\n\n// @ts-ignore\nexport type ContextValue<State, Update> = {\n  [MUTABLE_SOURCE_CONTEXT_PROPERTY]: any;\n  [UPDATE_CONTEXT_PROPERTY]: Update;\n};\n\nexport const createProvider = <State, Update extends (...args: any) => any, Props>(\n  CustomContext: Context<ContextValue<State, Update>>,\n  useValue: (props: Props) => readonly [State, Update],\n) => {\n  const Provider: FC<Props> = (props) => {\n    const listeners = useRef(new Set<() => void>());\n    const [state, update] = useValue(props);\n    const stateRef = useRef(state);\n    useIsomorphicLayoutEffect(() => {\n      stateRef.current = state;\n      runWithPriority(NormalPriority, () => {\n        listeners.current.forEach((listener) => listener());\n      });\n    });\n    const updateWithPriority = useCallback((...args: any) => (\n      runWithPriority(UserBlockingPriority, () => update(...args))\n    ), [update]) as Update;\n    const mutableSource = useMemo(() => createMutableSource({\n      [STATEREF_SOURCE_PROPERTY]: stateRef,\n      [LISTENERS_SOURCE_PROPERTY]: listeners,\n    }, () => stateRef.current), []);\n    const contextValue = useMemo(() => ({\n      [MUTABLE_SOURCE_CONTEXT_PROPERTY]: mutableSource,\n      [UPDATE_CONTEXT_PROPERTY]: updateWithPriority,\n    }), [mutableSource, updateWithPriority]);\n    return createElement(CustomContext.Provider, { value: contextValue }, props.children);\n  };\n  return Provider;\n};\n\nexport const subscribe = (\n  source: { [LISTENERS_SOURCE_PROPERTY]: MutableRefObject<Set<() => void>> },\n  callback: () => void,\n) => {\n  const listeners = source[LISTENERS_SOURCE_PROPERTY].current;\n  listeners.add(callback);\n  return () => listeners.delete(callback);\n};\n","import { Context, useContext } from 'react';\n\nimport { ContextValue, UPDATE_CONTEXT_PROPERTY } from './createProvider';\n\nexport const useUpdate = <State, Update>(\n  CustomContext: Context<ContextValue<State, Update>>,\n) => {\n  const { [UPDATE_CONTEXT_PROPERTY]: update } = useContext(CustomContext);\n  return update;\n};\n","/* eslint-disable @typescript-eslint/ban-ts-ignore */\n\nimport {\n  Context,\n  MutableRefObject,\n  useContext,\n  useMemo,\n  // @ts-ignore\n  useMutableSource,\n} from 'react';\nimport {\n  createDeepProxy,\n  isDeepChanged,\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED,\n  MODE_IGNORE_REF_EQUALITY,\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP,\n} from 'proxy-compare';\n\nimport { useAffectedDebugValue } from './utils';\nimport {\n  ContextValue,\n  MUTABLE_SOURCE_CONTEXT_PROPERTY,\n  STATEREF_SOURCE_PROPERTY,\n  subscribe,\n} from './createProvider';\nimport { useUpdate } from './useUpdate';\n\nconst MODE_ALWAYS_ASSUME_CHANGED_IF_UNAFFECTED = 0;\nconst MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED = (\n  MODE_ASSUME_UNCHANGED_IF_UNAFFECTED | MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP\n);\nconst MODE_MUTABLE_ROOT_STATE = MODE_IGNORE_REF_EQUALITY; // only for root\nconst MODE_DEFAULT = MODE_ASSUME_UNCHANGED_IF_UNAFFECTED; // only for root\n\ntype Opts = any; // TODO types\n\nexport const useTrackedState = <State, Update>(\n  CustomContext: Context<ContextValue<State, Update>>,\n  opts: Opts = {},\n) => {\n  const {\n    [MUTABLE_SOURCE_CONTEXT_PROPERTY]: mutableSource,\n  } = useContext(CustomContext);\n  const affected = new WeakMap();\n  const deepChangedMode = (\n    /* eslint-disable no-nested-ternary, indent, no-multi-spaces */\n      opts.unstable_forceUpdateForStateChange     ? MODE_ALWAYS_ASSUME_CHANGED_IF_UNAFFECTED\n    : opts.unstable_ignoreIntermediateObjectUsage ? MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED\n    : opts.unstable_ignoreStateEquality           ? MODE_MUTABLE_ROOT_STATE\n    : /* default */                                 MODE_DEFAULT\n    /* eslint-enable no-nested-ternary, indent, no-multi-spaces */\n  );\n  const getSnapshot = useMemo(() => {\n    let prevState: State | null = null;\n    const deepChangedCache = new WeakMap();\n    return (source: {\n      [STATEREF_SOURCE_PROPERTY]: MutableRefObject<State>;\n    }) => {\n      const nextState = source[STATEREF_SOURCE_PROPERTY].current;\n      if (prevState !== null && prevState !== nextState && !isDeepChanged(\n        prevState,\n        nextState,\n        affected,\n        deepChangedCache,\n        deepChangedMode,\n      )) {\n        // not changed\n        return prevState;\n      }\n      prevState = nextState;\n      return nextState;\n    };\n  }, [affected, deepChangedMode]);\n  const state: State = useMutableSource(mutableSource, getSnapshot, subscribe);\n  if (process.env.NODE_ENV !== 'production') {\n    // eslint-disable-next-line react-hooks/rules-of-hooks\n    useAffectedDebugValue(state, affected);\n  }\n  const proxyCache = useMemo(() => new WeakMap(), []); // per-hook proxyCache\n  return createDeepProxy(state, affected, proxyCache);\n};\n\nexport const useTracked = <State, Update>(\n  CustomContext: Context<ContextValue<State, Update>>,\n  opts?: Opts,\n) => {\n  const state = useTrackedState(CustomContext, opts);\n  const update = useUpdate(CustomContext);\n  return useMemo(() => [state, update], [state, update]) as [State, Update];\n};\n","/* eslint-disable @typescript-eslint/ban-ts-ignore */\n\nimport {\n  Context,\n  MutableRefObject,\n  useCallback,\n  useContext,\n  // @ts-ignore\n  useMutableSource,\n} from 'react';\n\nimport {\n  ContextValue,\n  MUTABLE_SOURCE_CONTEXT_PROPERTY,\n  STATEREF_SOURCE_PROPERTY,\n  subscribe,\n} from './createProvider';\n\nexport const useSelector = <State, Update, Selected>(\n  CustomContext: Context<ContextValue<State, Update>>,\n  selector: (state: State) => Selected,\n) => {\n  const {\n    [MUTABLE_SOURCE_CONTEXT_PROPERTY]: mutableSource,\n  } = useContext(CustomContext);\n  const getSnapshot = useCallback(\n    (source: { [STATEREF_SOURCE_PROPERTY]: MutableRefObject<State> }) => (\n      selector(source[STATEREF_SOURCE_PROPERTY].current)\n    ),\n    [selector],\n  );\n  return useMutableSource(mutableSource, getSnapshot, subscribe);\n};\n","import {\n  createContext,\n} from 'react';\n\nimport { ContextValue, createProvider } from './createProvider';\nimport {\n  useTrackedState as useTrackedStateOrig,\n  useTracked as useTrackedOrig,\n} from './useTrackedState';\nimport { useUpdate as useUpdateOrig } from './useUpdate';\nimport { useSelector as useSelectorOrig } from './useSelector';\n\nexport const createContainer = <State, Update extends (...args: any) => any, Props>(\n  useValue: (props: Props) => readonly [State, Update],\n) => {\n  const context = createContext(new Proxy({}, {\n    get() { throw new Error('Please use <Provider>'); },\n  }) as ContextValue<State, Update>);\n  const Provider = createProvider(context, useValue);\n  const useTrackedState = (\n    opts?: Parameters<typeof useTrackedStateOrig>[1],\n  ) => useTrackedStateOrig(context, opts);\n  const useTracked = (\n    opts?: Parameters<typeof useTrackedOrig>[1],\n  ) => useTrackedOrig(context, opts);\n  const useUpdate = () => useUpdateOrig(context);\n  const useSelector = <Selected>(\n    selector: (state: State) => Selected,\n  ) => useSelectorOrig(context, selector);\n  return {\n    Provider,\n    useTrackedState,\n    useTracked,\n    useUpdate,\n    useSelector,\n  } as const;\n};\n"],"names":["useIsomorphicLayoutEffect","window","test","navigator","userAgent","useEffect","useLayoutEffect","createProvider","CustomContext","useValue","props","listeners","useRef","Set","state","update","stateRef","current","runWithPriority","NormalPriority","forEach","listener","updateWithPriority","useCallback","args","UserBlockingPriority","mutableSource","useMemo","createMutableSource","contextValue","createElement","Provider","value","children","subscribe","source","callback","add","useUpdate","useContext","MODE_ALWAYS_ASSUME_UNCHANGED_IF_UNAFFECTED","MODE_ASSUME_UNCHANGED_IF_UNAFFECTED","MODE_ASSUME_UNCHANGED_IF_UNAFFECTED_IN_DEEP","MODE_MUTABLE_ROOT_STATE","MODE_IGNORE_REF_EQUALITY","MODE_DEFAULT","useTrackedState","opts","affected","WeakMap","deepChangedMode","unstable_forceUpdateForStateChange","unstable_ignoreIntermediateObjectUsage","unstable_ignoreStateEquality","getSnapshot","prevState","deepChangedCache","nextState","isDeepChanged","useMutableSource","process","env","NODE_ENV","pathList","list","walk","obj","path","used","get","key","push","affectedToPathList","useDebugValue","useAffectedDebugValue","proxyCache","createDeepProxy","useTracked","useSelector","selector","context","createContext","Proxy","Error","useTrackedStateOrig","useTrackedOrig","useUpdateOrig","useSelectorOrig"],"mappings":"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"}